<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0e5e55">
<title>Diagnos</title>

<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" sizes="192x192" href="./icons/icon-192.png">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root{--bg:#e6f3ee;--brand:#0e5e55}
  body{background:var(--bg);color:#0e2a26}
  .app{max-width:420px;margin:auto;min-height:100dvh;display:flex;flex-direction:column}
  .card-soft{background:#cfe7df;border:none;border-radius:14px}
  .hidden{display:none !important}
  .nav-bottom{position:sticky;bottom:0;z-index:10}
  section.page{padding:12px 16px}
  .step-dot{width:8px;height:8px;border-radius:50%;background:#bcd7cf}
  .step-dot.active{background:var(--brand)}
</style>
</head>
<body>
<div class="app">

  <!-- Header: hanya tampil di app (bukan onboarding) -->
  <header id="appHeader" class="p-3 d-none">
    <div class="d-flex align-items-center gap-2">
      <div class="rounded-circle bg-success text-white fw-bold d-grid" style="width:32px;height:32px;place-items:center">D</div>
      <div>
        <div class="small text-muted">Halo, <span id="userName">Guest</span></div>
        <div class="small">Rekomendasi Sehat Anda</div>
      </div>
      <button id="installBtn" class="btn btn-success btn-sm ms-auto d-none">Pasang App</button>
    </div>
  </header>

  <!-- ===================== PAGES (SECTIONS) ===================== -->

  <!-- Onboarding: Welcome -->
  <section id="onb-welcome" class="page">
    <div class="text-center mb-3">
      <div class="rounded-circle bg-success text-white fw-bold d-inline-grid" style="width:56px;height:56px;place-items:center">D</div>
      <h5 class="mt-2">Selamat Datang di Diagnos</h5>
      <div class="small text-muted">Kelola pemeriksaan & aksi sehat Anda.</div>
    </div>
    <div class="card card-soft p-3 mb-3">
      <div class="fw-semibold">Apa saja fiturnya?</div>
      <ul class="small text-muted mb-0">
        <li>Rekomendasi MCU & pemesanan</li>
        <li>Home Care & pengingat jadwal</li>
        <li>Simpan hasil & tips kesehatan</li>
      </ul>
    </div>
    <div class="d-flex justify-content-center gap-2 my-3">
      <div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div>
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-success" data-go="onb-perms">Lanjut</button>
      <button class="btn btn-outline-success" data-skip>Lewati (Guest)</button>
    </div>
  </section>

  <!-- Onboarding: Permissions -->
  <section id="onb-perms" class="page hidden">
    <h5 class="mb-2">Izin & Persetujuan</h5>
    <div class="card card-soft p-3 mb-3">
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="permNotif">
        <label class="form-check-label small" for="permNotif">Izinkan notifikasi pengingat jadwal</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="permLoc">
        <label class="form-check-label small" for="permLoc">Gunakan lokasi saat memesan Home Care</label>
      </div>
      <div class="small text-muted mt-2">Bisa diubah nanti di Akun.</div>
    </div>
    <div class="d-flex justify-content-center gap-2 my-3">
      <div class="step-dot"></div><div class="step-dot active"></div><div class="step-dot"></div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-success" data-go="onb-welcome">Kembali</button>
      <button class="btn btn-success ms-auto" data-go="onb-details">Lanjut</button>
    </div>
  </section>

  <!-- Onboarding: Create Account -->
  <section id="onb-details" class="page hidden">
    <h5 class="mb-2">Buat Akun</h5>
    <div class="small text-muted mb-3">
      Data: NIK, Nama, Gender & Tgl Lahir, Email & Phone, Alamat. <em>NIK belum diverifikasi di tahap ini.</em>
    </div>
    <form id="formOnb" class="card card-soft p-3">
      <div class="mb-2">
        <label class="form-label small">NIK</label>
        <input required maxlength="16" pattern="\\d{16}" class="form-control" name="nik" placeholder="16 digit">
      </div>
      <div class="mb-2">
        <label class="form-label small">Nama</label>
        <input required class="form-control" name="name">
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label small">Gender</label>
          <select class="form-select" name="gender"><option value="M">Pria</option><option value="F">Wanita</option></select>
        </div>
        <div class="col-6">
          <label class="form-label small">Tanggal Lahir</label>
          <input type="date" class="form-control" name="dob">
        </div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-6">
          <label class="form-label small">Email</label>
          <input type="email" class="form-control" name="email">
        </div>
        <div class="col-6">
          <label class="form-label small">Phone</label>
          <input type="tel" class="form-control" name="phone" placeholder="08xxxxxxxxxx">
        </div>
      </div>
      <div class="mt-2">
        <label class="form-label small">Alamat</label>
        <textarea rows="2" class="form-control" name="address"></textarea>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-outline-success" data-go="onb-perms" type="button">Kembali</button>
        <button class="btn btn-success ms-auto" type="submit">Daftarkan</button>
      </div>
    </form>
    <div class="d-flex justify-content-center gap-2 my-3">
      <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot active"></div>
    </div>
  </section>

  <!-- Onboarding: Success -->
  <section id="onb-success" class="page hidden text-center">
    <div class="rounded-circle bg-success text-white fw-bold d-inline-grid" style="width:56px;height:56px;place-items:center">‚úì</div>
    <h5 class="mt-3">Akun Dibuat</h5>
    <div class="small text-muted" id="successInfo"></div>
    <div class="d-grid gap-2 mt-4">
      <button class="btn btn-success" data-go="home">Masuk ke Beranda</button>
    </div>
  </section>

  <!-- HOME -->
  <section id="home" class="page hidden">
    <section class="mb-3">
      <div class="card card-soft p-3 mb-2">
        <div class="badge text-bg-light text-success mb-1">PROMOCARE</div>
        <div class="fw-semibold">MEDICAL CHECK UP SILVER</div>
        <ul class="small text-muted mb-2"><li>Profil darah, gula, kolesterol, Asam Urat</li></ul>
        <div class="d-flex align-items-center gap-2">
          <span class="text-decoration-line-through small text-muted">Rp 980.000</span>
          <strong>Rp 393.000</strong>
          <button class="btn btn-success btn-sm ms-auto" data-action="order">Ambil</button>
        </div>
      </div>
      <div class="card card-soft p-3">
        <div class="badge text-bg-light text-success mb-1">PROMOCARE</div>
        <div class="fw-semibold">MEDICAL CHECK UP PLATINUM</div>
        <ul class="small text-muted mb-2"><li>Profil darah, gula, kolesterol, fungsi organ</li></ul>
        <div class="d-flex align-items-center gap-2">
          <span class="text-decoration-line-through small text-muted">Rp 1.290.000</span>
          <strong>Rp 460.000</strong>
          <button class="btn btn-success btn-sm ms-auto" data-action="order">Ambil</button>
        </div>
      </div>
      <div class="text-end small text-muted mt-1">... lainnya &raquo;</div>
    </section>

    <section class="mb-3">
      <h6 class="fw-bold mb-2">Aksi Sehat</h6>
      <div class="row g-2">
        <div class="col-3"><a class="btn btn-light w-100 py-3" data-go="layanan">üóìÔ∏è<br><span class="small">Jadwal</span></a></div>
        <div class="col-3"><a class="btn btn-light w-100 py-3" data-go="riwayat">üìÑ<br><span class="small">Hasil</span></a></div>
        <div class="col-3"><a class="btn btn-light w-100 py-3" data-go="layanan">üè•<br><span class="small">Home Care</span></a></div>
        <div class="col-3"><a class="btn btn-light w-100 py-3" data-go="layanan">‚ÑπÔ∏è<br><span class="small">Program</span></a></div>
      </div>
    </section>

    <section>
      <h6 class="fw-bold mb-2">Tips Kesehatan</h6>
      <div class="card card-soft p-3">
        <strong>DIET TEPAT USIA EMAS</strong>
        <div class="small text-muted">Program asupan usia matang.</div>
      </div>
    </section>
  </section>

  <!-- RIWAYAT -->
  <section id="riwayat" class="page hidden">
    <h6 class="fw-bold mb-2">Riwayat Pemeriksaan</h6>
    <div class="card card-soft p-3 mb-2">
      <div class="fw-semibold">MCU Silver - 02 Agu 2025</div>
      <div class="small text-muted mb-2">Ringkasan: Normal, cek ulang 6 bulan.</div>
      <button class="btn btn-success btn-sm" data-action="lihat-hasil">Lihat Hasil</button>
    </div>
    <div class="small text-muted">Belum ada data lain.</div>
  </section>

  <!-- LAYANAN -->
  <section id="layanan" class="page hidden">
    <h6 class="fw-bold mb-2">Layanan</h6>
    <div class="card card-soft p-3 mb-2">
      <div class="fw-semibold">Booking Jadwal</div>
      <div class="small text-muted mb-2">Pilih cabang & tanggal.</div>
      <button class="btn btn-success btn-sm" data-action="booking">Mulai</button>
    </div>
    <div class="card card-soft p-3">
      <div class="fw-semibold">Home Care</div>
      <div class="small text-muted mb-2">Kunjungan petugas ke lokasi Anda.</div>
      <button class="btn btn-success btn-sm" data-action="homecare">Ajukan</button>
    </div>
  </section>

  <!-- AKUN -->
  <section id="akun" class="page hidden">
    <h6 class="fw-bold mb-2">Akun</h6>
    <div class="card card-soft p-3 mb-2">
      <div class="d-flex align-items-center gap-2">
        <div class="rounded-circle bg-success text-white d-grid" style="width:42px;height:42px;place-items:center">üë§</div>
        <div>
          <div class="fw-semibold" id="akunName">Guest</div>
          <div class="small text-muted" id="akunMeta"></div>
        </div>
      </div>
    </div>

    <div class="card card-soft p-3 mb-2">
      <div class="fw-semibold mb-1">Pasien</div>
      <div class="small text-muted">ID Pasien: <span id="akunPid">-</span></div>
      <div class="small">Status NIK: <strong id="akunNikStatus">Belum Verifikasi</strong></div>
      <button class="btn btn-outline-success btn-sm mt-2" data-action="verify-nik">Verify NIK (mock)</button>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="notif">
      <label class="form-check-label small" for="notif">Aktifkan notifikasi</label>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-success btn-sm" data-go="onb-details">Ubah Profil</button>
      <button class="btn btn-danger btn-sm ms-auto" data-action="logout">Logout</button>
    </div>
  </section>

  <!-- ===================== /PAGES ===================== -->

  <!-- Bottom Nav -->
  <nav id="bottomNav" class="navbar navbar-dark bg-success nav-bottom d-none">
    <div class="container-fluid justify-content-around">
      <a class="nav-link text-white small" data-go="home">üè†<br>Home</a>
      <a class="nav-link text-white small" data-go="riwayat">üóÇÔ∏è<br>Riwayat</a>
      <a class="nav-link text-white small" data-go="layanan">üß™<br>Layanan</a>
      <a class="nav-link text-white small" data-go="akun">üë§<br>Akun</a>
    </div>
  </nav>
</div>

<script>
/* ======== STATE ======== */
const state = {
  onboarded: JSON.parse(localStorage.getItem('onboarded') || 'false'),
  user: JSON.parse(localStorage.getItem('user') || '{}'), // {nik,name,gender,dob,email,phone,address,patientId,nikVerified}
  notif: JSON.parse(localStorage.getItem('notif') || 'false')
};
const save = () => localStorage.setItem('user', JSON.stringify(state.user));

/* ======== SECTION ROUTER (show/hide) ======== */
function showChrome(show){ // header + bottom nav
  $('#appHeader').toggleClass('d-none', !show);
  $('#bottomNav').toggleClass('d-none', !show);
}
function showSection(id){
  $('section.page').addClass('hidden');
  $('#'+id).removeClass('hidden');

  const onboarding = id.startsWith('onb-');
  showChrome(!onboarding);

  // refresh header & akun info
  $('#userName').text(state.user?.name || 'Guest');
  $('#notif').prop('checked', !!state.notif);
  $('#akunName').text(state.user?.name || 'Guest');
  const meta = (state.user?.dob ? calcAge(state.user.dob)+' ‚Ä¢ ' : '') + (state.user?.gender==='M'?'Pria':state.user?.gender==='F'?'Wanita':'');
  $('#akunMeta').text(meta);
  $('#akunPid').text(state.user?.patientId || '-');
  $('#akunNikStatus').text(state.user?.nikVerified ? 'Terverifikasi' : 'Belum Verifikasi');
}
const startPage = state.onboarded ? 'home' : 'onb-welcome';
showSection(startPage);

/* ======== NAV HANDLERS (versi dengan history) ======== */
$(document).on('click','[data-go]', function(){
  const target = $(this).data('go');
  if (window.location.hash.replace('#','') !== target) {
    window.location.hash = target; // biar masuk ke history
  }
});

// Handle tombol back/forward di browser atau device
$(window).on('hashchange', ()=>{
  const id = location.hash.replace('#','');
  if (id) {
    showSection(id);
  } else {
    // fallback jika hash kosong
    showSection(state.onboarded ? 'home' : 'onb-welcome');
  }
});


/* ======== ONBOARDING LOGIC ======== */
$(document).on('click','[data-skip]', ()=>{
  state.onboarded = true; localStorage.setItem('onboarded','true');
  showSection('home');
});
$('#permNotif').on('change', function(){
  state.notif = $(this).is(':checked'); localStorage.setItem('notif', JSON.stringify(state.notif));
  if (state.notif && 'Notification' in window) Notification.requestPermission();
});
$('#permLoc').on('change', function(){
  if($(this).is(':checked') && navigator.geolocation){ navigator.geolocation.getCurrentPosition(()=>{},()=>{}); }
});
$('#formOnb').on('submit', function(e){
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this).entries());
  state.user = {...state.user, ...data, nikVerified:false, patientId: genPid()};
  localStorage.setItem('onboarded','true'); state.onboarded = true; save();
  $('#successInfo').html(`ID Pasien: <strong>${state.user.patientId}</strong>. Status NIK: <strong>Belum Verifikasi</strong>.`);
  showSection('onb-success');
});

/* ======== APP ACTIONS ======== */
$(document).on('change','#notif', function(){
  state.notif = $(this).is(':checked'); localStorage.setItem('notif', JSON.stringify(state.notif));
});
$(document).on('click','[data-action="verify-nik"]', ()=>{
  setTimeout(()=>{ state.user.nikVerified = true; save(); alert('NIK terverifikasi (mock)'); showSection('akun'); }, 400);
});
$(document).on('click','[data-action="logout"]', ()=>{
  if(confirm('Keluar dan hapus data lokal?')){
    localStorage.clear(); state.onboarded=false; state.user={}; state.notif=false;
    showSection('onb-welcome');
  }
});
$(document).on('click','[data-action="order"]', ()=> alert('Order dimulai (mock)...'));
$(document).on('click','[data-action="booking"]', ()=> alert('Booking jadwal (mock)...'));
$(document).on('click','[data-action="homecare"]', ()=> alert('Ajukan Home Care (mock)...'));
$(document).on('click','[data-action="lihat-hasil"]', ()=> alert('Menampilkan hasil (mock)...'));

/* ======== UTIL ======== */
function genPid(){ return 'PX' + Date.now().toString().slice(-6); }
function calcAge(dob){
  try{ const d=new Date(dob), n=new Date(); let y=n.getFullYear()-d.getFullYear(); let m=n.getMonth()-d.getMonth(); if(n.getDate()<d.getDate()) m--; if(m<0){y--; m+=12} return `${y} Tahun, ${m} bulan`; }catch(_){ return '' }
}

/* ======== PWA (SW + update flow) ======== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    const reg = await navigator.serviceWorker.register('./sw.js');

    function onNewServiceWorker(reg, callback) {
      if (!reg) return;
      if (reg.waiting) return callback();
      function listenInstalling() {
        if (reg.installing) {
          reg.installing.addEventListener('statechange', function () {
            if (this.state === 'installed' && reg.waiting) callback();
          });
        }
      }
      if (reg.installing) listenInstalling();
      else reg.addEventListener('updatefound', listenInstalling);
    }

    // Otomatis aktifkan SW baru (hard reset cache) saat tersedia
    onNewServiceWorker(reg, () => {
      reg.waiting.postMessage('SKIP_WAITING');
    });
  });

  // Reload sekali ketika SW baru menguasai halaman
  let refreshed = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshed) return;
    refreshed = true;
    location.reload();
  });
}



let deferredPrompt; const installBtn = $('#installBtn');
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e; installBtn.removeClass('d-none');
});
installBtn.on('click', async ()=>{
  if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice;
  deferredPrompt = null; installBtn.addClass('d-none');
});
</script>

</body>
</html>
